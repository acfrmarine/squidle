#!/usr/bin/python
import csv
import os
import os.path
import errno
import datetime
from dateutil.tz import tzutc
import Image

def timestamp_to_standard(seconds):
    return str(datetime.datetime.fromtimestamp(seconds, tz=tzutc()))

def convert_image(image_folder, image_name):
    source_image = os.path.join(image_folder, image_name)
    base_file = os.path.splitext(image_name)[0]
    destination_image = "images/{0}.jpg".format(base_file)

    try:
        im = Image.open(source_image)
        im.save(destination_image, "JPEG", quality=100)
    except IOError as err:
        print "Error: {0}".format(source_image)

    #print source_image, '=>', destination_image

def convert(renav_folder, image_folder):
    # preliminaries - create sensors and cameras.csv
    # also create empty/default description.txt and create
    # images directory

    try:
        os.mkdir('images')
    except OSError as exc:
        if exc.errno == errno.EEXIST and os.path.isdir('images'):
            pass
        else:
            raise

    cameras = """name,angle,filename,columnname,sensors
Left Colour, Downward, path.csv, Left Image"""
    sensors = """sensortype,filename,columnname,camera
    Altitude, path.csv, Altitude, None"""
    description = """Blank description."""

    with open('cameras.csv', 'w') as camera_file:
        camera_file.write(cameras)

    with open('sensors.csv', 'w') as sensor_file:
        sensor_file.write(sensors)

    with open('description.txt', 'w') as description_file:
        description_file.write(description)

    # load up the stereo poses and related info
    stereo_pose_est = open(os.path.join(renav_folder, 'stereo_pose_est.data'))
    headings = ['time', 'latitude', 'longitude', 'depth', 'Left Image', 'Altitude']

    reader = csv.reader(stereo_pose_est, delimiter='\t')
    writer = csv.DictWriter(open('path.csv','w'), fieldnames=headings)

    writer.writeheader()

    for line in reader:
        if len(line) <= 1:
            continue

        # path requirements
        output = [timestamp_to_standard(float(line[1]))]
        output.append(line[2].strip())
        output.append(line[3].strip())
        output.append(line[6].strip())

        # extra things!
        output_file = "{0}.jpg".format(os.path.splitext(line[10].strip())[0])
        output.append(output_file) # image name
        output.append(line[12].strip()) # altitude

        writer.writerow(dict(zip(headings,output)))
        
        if image_folder is not None:
            convert_image(image_folder, line[10].strip())

if __name__ == '__main__':
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("renav_directory")
    parser.add_argument("image_directory")
    parser.add_argument("--ignore-images", action='store_true', default=False)
    args = parser.parse_args()

    if args.ignore_images:
        convert(args.renav_directory, None)
    else:
        convert(args.renav_directory, args.image_directory)

