#!/bin/bash -x
#==================================================#
# BUILDS THE SQUIDLE SERVER FROM A FRESH 
# INSTALL OF UBUNTU
# -------------------------------------------------#

SERVER="http://squidle.acfr.usyd.edu.au"
SQUIDLE_HOME="./"

MEDIA_ROOT="/media/data/squidle-media"
IMPORT_PATH="$MEDIA_ROOT/importedimages"
STATIC_ROOT="$MEDIA_ROOT/static"

#mkdir -p $SQUIDLE_HOME
mkdir -p $MEDIA_ROOT

# make media dirs and setup apache to serve imagery
mkdir -p $MEDIA_ROOT/static
mkdir -p $MEDIA_ROOT/importedimages

chmod -R 777 $MEDIA_ROOT

#== 
# Prepare Apache
#==
#cp 000-default /etc/apache2/sites-enabled/

#==================================================#
# SETUP THE POSGIS TEMPLATE FOR POSTGRESQL
#==================================================#
#start postgres
/etc/init.d/postgresql restart

GEOGRAPHY=0
POSTGIS_SQL=postgis.sql

if [ -d "/usr/share/postgresql/9.1/contrib/postgis-1.5" ]
then
    POSTGIS_SQL_PATH=/usr/share/postgresql/9.1/contrib/postgis-1.5
    GEOGRAPHY=1
fi

su postgres -c "createdb -E UTF8 template_postgis" && \
su postgres -c "( createlang -d template_postgis -l | grep plpgsql || createlang -d template_postgis plpgsql )" && \
su postgres -c "psql -d postgres -c \"UPDATE pg_database SET datistemplate='true' WHERE datname='template_postgis';\"" && \
su postgres -c "psql -d template_postgis -f $POSTGIS_SQL_PATH/$POSTGIS_SQL" && \
su postgres -c "psql -d template_postgis -f $POSTGIS_SQL_PATH/spatial_ref_sys.sql" && \
su postgres -c "psql -d template_postgis -c \"GRANT ALL ON geometry_columns TO PUBLIC;\"" && \
su postgres -c "psql -d template_postgis -c \"GRANT ALL ON spatial_ref_sys TO PUBLIC;\""

if [ $GEOGRAPHY -eq 1 ]
then
    su postgres -c "psql -d template_postgis -c \"GRANT ALL ON geography_columns TO PUBLIC;\""
fi

#==================================================#
# SETUP THE DATABASE AND USERS
#==================================================#

su postgres -c "psql -c \"SELECT 1 from pg_roles WHERE rolname='$U_NAME'\"" | grep -q 1 || su postgres -c "createuser -Rs -A -d -U postgres $U_NAME"
su postgres -c "psql -c \"SELECT 1 from pg_database WHERE datname='catamidb'\"" | grep -q 1 || su postgres -c "createdb -E utf8 -O $U_NAME -T template_postgis catamidb"

sed -i '1a#!! Autogenerated by Jujuj squidleportal charm !!' /etc/postgresql/9.1/main/pg_hba.conf
sed -i "2alocal	        all     $U_NAME                  md5"  /etc/postgresql/9.1/main/pg_hba.conf
sed -i '3ahost		all	all	0.0.0.0/0	md5' /etc/postgresql/9.1/main/pg_hba.conf

sed -i 's/#listen_addresses = /listen_addresses =/' /etc/postgresql/9.1/main/postgresql.conf
sed -i "s/localhost/*/" /etc/postgresql/9.1/main/postgresql.conf

sed -i "s/#port = 5432/port = 5432 #sed gen/" /etc/postgresql/9.1/main/postgresql.conf

#juju-log "Restarting postgres"
echo "Restarting postgres"
/etc/init.d/postgresql restart

#==================================================#
# SETUP THE PYTHON ENVIRONMENT
#==================================================#
#juju-log "Setting up the python environment"
easy_install pip

#juju-log "Pip installing python dependencies" 
pip install -r requirements.txt

# local_settings.py
touch $SQUIDLE_HOME/catamiPortal/local_settings.py 

#update main django settings for the current server
sed -i "s@WMS_URL =.*@WMS_URL = \"$SERVER:8080/geoserver/wms\" @g" $SQUIDLE_HOME/catamiPortal/conf/settings/default.py
sed -i "s@IMPORT_PATH.*@IMPORT_PATH = \'$IMPORT_PATH\'@g" $SQUIDLE_HOME/catamiPortal/conf/settings/default.py
sed -i "s@STATIC_ROOT.*@STATIC_ROOT = \'$STATIC_ROOT\'@g" $SQUIDLE_HOME/catamiPortal/conf/settings/default.py
sed -i "s@MEDIA_ROOT.*@MEDIA_ROOT = \'$MEDIA_ROOT\'@g" $SQUIDLE_HOME/catamiPortal/conf/settings/default.py

#configure project username and password
sed -i "s@pocock@$U_NAME@g" $SQUIDLE_HOME/catamiPortal/conf/settings/default.py
sed -i "s@qwer789ASDF456zxcv123@$PASSWORD@g" $SQUIDLE_HOME/catamiPortal/conf/settings/default.py

#juju-log "syncing database"
python manage.py syncdb --noinput

#==================================================#
# SETUP INITIAL MIGRATION FOR SOUTH
#==================================================#

#!!! accounts may need to be after accounts in the following list of apps
python manage.py migrate --all
python manage.py syncdb --all --noinput

#load the waffle fixtures for feature switching
python manage.py loaddata projects/fixtures/catami_classification_tree.json

#this if for django-guardian, make sure users all have the requires permission associated
python manage.py check_permissions

python manage.py collectstatic --noinput

chmod a+rw log/catamiPortal.log

#juju-log "set up Django superuser"
echo "Configuring Django superuser"
echo "from django.contrib.auth.models import User; User.objects.create_superuser('$U_NAME', 'squidle@acfr.usyd.edu.au', '$PASSWORD')" | ./manage.py shell

#==================================================#
# SET UP APACHE PORT REVERSE PROXY
#==================================================#
a2enmod proxy_http
a2enmod rewrite

echo "Catami Portal install complete"

#==================================================#
# add the current directory and the parent directory to PYTHONPATH
# sets DJANGO_SETTINGS_MODULE
#==================================================#
export DJANGO_SETTINGS_MODULE=catamiPortal.settings

echo "... Done"
